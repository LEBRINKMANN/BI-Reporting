
/*Edit Date Ranges here*/
%let start_date = 29nov2021;
%let end_date = 28feb2022;

/*Find all Stryker PO's*/
proc sql;
create table orders as
select
q.line_item_id
, lid.pim_item_number
, lid.condition_code
from d_dw.rorm_all q /*Change to RORM_ALL to get all transactions*/
inner join d_dw.line_item_details lid on lid.line_item_id = q.line_item_id 
										 and lid.contract_pro_id is null and lid.Repair_Ind = 0
where q.orders=1 and q.transaction_date between "&start_date"D and "&end_Date"D 
and q.vendor_ID not in (17045,18671,16795,33934,25998,16690,18734,24933,36314,24402,16497,16907,56068,89815,36636,83553,34884,134502,24339,26445,17273,25039,26630,24988,108700,63521,17610,25204,16344,115759,17562,18365,44557,20006,18353,17590,18527,22116,24933,47493,18085,22310,16607,17467,18091,21191,18523,33459,18519,24933,84087,16146,37260,17192,28791,16677,37555,18211,23358,17080,17392,29443,21481,21481,16846,17210,18826,28160) 
and lid.pim_item_number not in ("V17581-H2390P01","V16418-0668871000","V16418-0117832000","V16418-0117837000","V16418-0117833000","V16418-0113026000","V16418-0336830000","V16418-0157895000","V16418-0127843000","V16418-0117829000","V16418-0137821000","V16418-0518889000","V16418-0539A02304","V16418-0561350400","V16418-0117834000","V16418-0123026100","V16418-0157896000","V16418-0561350600","V16418-0518889400","V16418-0137822000","V16418-0338036000","V16418-0127844000","V16418-0661510000","V16418-0117830000","V16418-0197842100","V16418-0127839000","V16418-0727808000","V16418-0117835000","V16418-0217850000","V16418-0137823000","V16418-0661515000","V16418-0528890000","V16418-0928773000","V16418-0727808100","V16418-1011251000","V16418-0127845000","V16418-0339244000","V16418-0541110100","V16418-0528890400","V16418-0227754000","V16418-0668867000","V16418-0137824000","V16418-0127840000","V16418-0117831000","V16418-092877320P","V16418-0571410000","V16418-1011260000","V16418-0117836000","V16418-0541110200","V16418-0237857000","V16418-0531415000","V16418-0817766000","V16418-0668869000","V16418-0137825000","V16418-1027714001","V16418-0571410400","V16418-1012041096","V16418-0962010000","V16418-0127846000","V16418-0247859000","V16418-0137826000","V16418-0531415400","V16418-0517794000","V16418-1027745000","V16418-1017757000","V16418-0638841000","V16418-0257852000","V16418-0127841000","V16418-0817766001","V16418-0671520000","V16418-0537792000","V16418-0638841200","V16418-1027745001","V16418-0317856000","V16418-0127847000","V16418-0137827000","V16418-1017757100","V16418-0517794400","V16418-0817766066","V16418-1317879001","V16418-0317856003","V16418-0717807000","V16418-1027745002","V16418-0157892000","V16418-0648848000","V16418-0537792002","V16418-0127842000","V16418-0561305000","V16418-0962018000","V16418-0828766000","V16418-0157893000","V16418-1317880000","V16418-1027745003","V16418-0717807066","V16418-0661501000","V16418-0537792004","V16418-1017761000","V16418-0927772400","V16418-0561305401","V16418-0962025000","V16418-0537792400","V16418-1118044000","V16418-14B7921200","V16418-1317880001","V16418-0717807100","V16418-14B7927243","V16418-1537971002","V16418-0561310000","V16418-096211800P","V16418-1317881000","V16418-1118047000","V16418-2012224000","V16418-2013235000","V16418-1317881001","V16418-0962230000","V16418-0717807166","V16418-1713224000","V16418-1118048000","V16418-14B7921243","V16418-0561315000","V16418-0927774000","V16418-14BSW30200","V16418-1017761100","V16418-2013235001","V16418-096230100P","V16418-2012224001","V16418-1713735000","V16418-14BSW30243","V16418-1017763000","V16418-14B7922200","V16418-1118049000","V16418-092777420P","V16418-2013435000","V16418-1021251640","V16418-2013235002","V16418-0561315400","V16418-1713747000","V16418-14B7922243","V16418-1517953000","V16418-1317878000","V16418-1017763100","V16418-1027445000","V16418-2013235200","V16418-2020235000","V16418-2012324000","V16418-1317878001","V16418-1527956000","V16418-1027445001","V16418-2013535000","V16418-1716724000","V16418-14B7924200","V16418-2013835000","V16418-1317879000","V16418-1537959000","V16418-14B7924243","V16418-1027714000","V16418-1718235000","V16418-2020335000","V16418-1537960000","V16418-14B7925200","V16418-1718247000","V16418-2012124000","V16418-2030524000","V16418-2030635000","V16418-1537970000","V16418-14B7925243","V16418-1813612000","V16418-2013335000","V16418-2030424000","V16418-2013635000","V16418-14B7927200","V16418-1537970002","V16418-2030535000","V16418-2023035000","V16418-1537971000","V16418-2030535180","V16418-2030435000","V16418-2012724000","V16418-2410396000","V16418-2013735000","V16418-2020224000","V16418-2833400000","V16418-2020435000","V16418-2013735001","V16418-2410496000","V16418-2422440000","V16418-2020324000","V16418-1018862300","V16418-1339882P00","V16418-1018862000","V16418-1339881W00","V16418-05413700RH","V16418-1339882W00","V16418-0561370400","V16418-1021113225","V16418-0157901000","V16418-0561370600","V16418-0157902000","V16418-1021113325","V16418-0429000000","V16418-1021113125","V16418-1021113025","V16418-0541370400","V16418-0541370600","V16418-1041205025","V16418-1041206025","V16418-1041210125","V16418-1041212025","V16418-1041210225","V16418-1041210025","V16418-1041212125","V16418-1041210325","V16418-1339883P00","V16418-1339883W00","V16418-1339881P00","V16418-0727808166","V16418-162DSHB000","V16418-0177835000","V16418-0187837100","V16418-1041201325","V16418-2110240244","V16418-0197839100","V16418-0197845100","V16418-0187832100","V16418-1339881WED","V16418-2293332E00","V16418-162DSBC000","V16418-0429100000","V16418-0187835100","V16418-0197825100","V16418-162DSHY017","V16418-0147862000","V16418-2293335000","V16418-0197843100","V16418-1051131025","V16418-0187830100","V16418-0197821000","V16418-2293331000","V16418-0187833100","V16418-1011261000","V16418-162DSBC001","V16418-0187836100","V16418-0177836030","V16418-2110350254","V16418-0197840100","V16418-05413710RH","V16418-1051130025","V16418-2427534000","V16418-0147863000","V16418-162DSHB001","V16418-0197827100","V16418-1041200125","V16418-2013535002","V16418-0187834100","V16418-0197824100","V16418-0187829100","V16418-0197841100","V16418-0187831100","V16418-0197844100","V16418-2293332000","V16418-1051130125","V16418-1339881PED","V16418-1339882PED","V16418-2293333000","V16418-0197846100","V16418-162DSHY000","V16418-0197847100","V16418-1339882WED","V16418-2293334000","V16418-1317878004","V16418-1339883WED","V16418-2427535000","V16418-0197822100","V16418-22933G3000","V16418-1051120025","V16418-1317880004","V16418-0539A023RH","V16418-2427537000","V16418-0561350200","V16418-1118047KIT","V16418-22933G4000","V16418-0197823100","V16418-2427535001","V16418-1051120125","V16418-2427537001","V16418-22933G1000","V16418-0561370RH1","V16418-1317881003","V16418-1317879003","V16418-1118048KIT","V16418-0541371400","V16418-2427536000","V16418-0197826100","V16418-1051121025","V16418-22933G5000","V16418-22933G2000","V16418-2427534002","V16418-1317879004","V16418-1317881004","V16418-1118049KIT","V16418-0541371600","V16418-2427536001","V16418-0539A02302","V16418-1118044KIT","V16418-22933G2E00","V16418-1317880003","V16418-2427534001","V16418-1339883PED","V16418-0157895062","V16418-1317878003","V16418-0727808066","V31111-2031069009EBS","V37260-10013671EBS","V37260-10013672EBS","V37260-10360242EBS","V37260-11340","V37260-11430","V37260-11716426H","V37260-144424100","V37260-2016780001EBS","V37260-2031069002EBS","V37260-451261021051EBS","V37260-453564007191EBS","V37260-453564602631EBS","V37260-49000218EBS","V37260-49000295","V37260-49000355","V37260-49000432EBS","V37260-49000433EBS","V37260-49000436EBS","V37260-49000491EBS","V37260-8100RCS","V37260-989803140441EBS","V37260-989803140451EBS","V37260-H0000082","V37260-H0000142","V37260-TC10009596","V37260-TC10010839EBS","V37260-TC10013664EBS","V17245-5042","V37260-TC10009596","V4652-A37016T1","V4652-C43690R17MED","V4652-C44611R22MED","V4652-C61340R24MED","V4652-C70592R29MED","V4652-C73894","V4652-C738942MG","V65964-Z03NI748BDC002","V65964-Z02NI958PDC003","V65964-PRMDGPD12DC840","V65964-Z04OX52MSDC001","V65964-Z05OX23MSDC000","V65964-Z03NI608SDC000","Item2","etc...")
;quit;


/*Calculate business hours for contacting customer with quote*/
proc sql;
create table Order_timestamp as
select
o.line_item_id
, o.first_ordered_timestamp as Ordered
from d_dw.line_item_status_summary o
inner join work.orders ord on ord.line_item_id = o.line_item_id
;quit;

data calendar_convert;
set d_dw.calendar;
keep workday_ind sas_date;
sas_date = datepart(date_key);
run;

proc sql;
create table order_days as
select
s.line_item_id
, Ordered
, t.date_shipped
, ord.workday_ind as Back_to_Cust_workday
, datepart(Ordered) as odate
, datepart(t.date_shipped) as sdate
from Order_timestamp s
left join calendar_convert ord on ord.sas_date = datepart(Ordered)
left join d_dw.tracking_numbers t on t.line_item_id = s.line_item_id and t.shipment_leg_id =1
;quit;

/*Finding the business days between Order and Shipment*/
proc sql;
create table order_days_calc as
select
line_item_id
, Ordered
, date_shipped
, Back_to_Cust_workday
, case when sdate is null then . else (select sum(workday_ind) from calendar_convert where sas_date
	between odate and sdate)-w.workday_ind end as Back_to_cust_Days
from order_days s
left join work.calendar_convert w on w.sas_date = s.odate
;quit;

/*combining back to all stryker line items*/
proc sql;
create table orders_setup as
select
o.line_item_id
, o.pim_item_number
, o.condition_code
, c.Ordered
, c.date_shipped
, c.Back_to_Cust_workday
, c.Back_to_cust_Days
from work.orders o 
left join work.order_days_calc c on o.line_item_id = c.line_item_id
;quit;

proc means data=work.orders_setup noprint;
var Back_to_cust_Days;
output out=work.order_means n=n mean=mean min=min p5=p5 p10=p10 p25=p25 median=median p75=p75 p90=p90 p95=p95 max=max;
class pim_item_number condition_code;
run;

data final_output;
set work.order_means;
where _type_ = 3; /*Only show the combinations of PIM Item Number and Condition*/
run;

/*Aggregate and Summary metrics
proc sql;
create table final_orders_calc as
select
pim_item_number
, sum(1) as POs
, min(Back_to_cust_Days) as Min_Ship
, mean(Back_to_cust_Days) as Mean_Ship
, max(Back_to_cust_Days) as Max_Ship
from work.orders_setup
where pim_item_number is not null
group by
pim_item_number
order by pos desc
;quit;